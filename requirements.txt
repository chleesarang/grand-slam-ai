import streamlit as st
import google.generativeai as genai
from PIL import Image
import time
import os

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="Grand Slam AI Coach",
    page_icon="ğŸ†",
    layout="wide"
)

# --- í—¤ë” ---
st.markdown("""
    <div style='text-align:center; padding-bottom: 20px;'>
        <h1 style='color:#1E88E5;'>ğŸ† Grand Slam AI Coach (Video Edition)</h1>
        <p style='font-size:1.2rem;'>ì‚¬ì§„ì€ ë¬¼ë¡  ë™ì˜ìƒ ìŠ¤ìœ™ ë¶„ì„ê¹Œì§€</p>
    </div>
    """, unsafe_allow_html=True)

# --- ì‚¬ì´ë“œë°”: ì„¤ì • ---
with st.sidebar:
    st.header("âš™ï¸ ì„¤ì •")
    if "GOOGLE_API_KEY" in st.secrets:
        api_key = st.secrets["GOOGLE_API_KEY"]
        st.success("âœ… ì •í’ˆ ë¼ì´ì„¼ìŠ¤ ì¸ì¦ë¨")
    else:
        api_key = st.text_input("API Key ì…ë ¥", type="password")

    if not api_key:
        st.warning("âš ï¸ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        st.stop()

    genai.configure(api_key=api_key)

    st.markdown("---")
    st.subheader("ğŸ‘¤ ë‚´ ì •ë³´")
    player_level = st.selectbox("ë‚´ ë ˆë²¨", ["ì…ë¬¸ (í…Œë¦°ì´)", "ì´ˆê¸‰ (2.5-3.0)", "ì¤‘ê¸‰ (3.5-4.0)", "ìƒê¸‰ (4.5+)", "ì„ ìˆ˜ê¸‰"], index=2)
    play_style = st.selectbox("ë‚´ ìŠ¤íƒ€ì¼", ["ì˜¬ë¼ìš´ë”", "ê³µê²©í˜• ë² ì´ìŠ¤ë¼ì´ë„ˆ", "ìˆ˜ë¹„í˜• ë² ì´ìŠ¤ë¼ì´ë„ˆ", "ì„œë¸Œ ì•¤ ë°œë¦¬"], index=0)

# --- AI ëª¨ë¸ ì„¤ì • (Gemini 1.5 Pro ì‚¬ìš©) ---
# 1.5 ProëŠ” ë¹„ë””ì˜¤, ê¸´ í…ìŠ¤íŠ¸, ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì²˜ë¦¬í•˜ëŠ” ë©€í‹°ëª¨ë‹¬ ìµœê°• ëª¨ë¸ì…ë‹ˆë‹¤.
try:
    model = genai.GenerativeModel('gemini-1.5-pro')
except Exception as e:
    st.error(f"ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨: {e}")

# --- AI í˜ë¥´ì†Œë‚˜ ---
grand_slam_prompt = f"""
ë‹¹ì‹ ì€ 'Grand Slam AI'ì…ë‹ˆë‹¤. ì„¸ê³„ ìµœê³ ì˜ í…Œë‹ˆìŠ¤ ì½”ì¹˜ì…ë‹ˆë‹¤.
ì‚¬ìš©ì ë ˆë²¨: {player_level}, ìŠ¤íƒ€ì¼: {play_style}.

**ë¶„ì„ ì›ì¹™:**
1. ë™ì˜ìƒì´ ì£¼ì–´ì§€ë©´ [ì¤€ë¹„ ìì„¸ - ì„íŒ©íŠ¸ - íŒ”ë¡œìš°ìŠ¤ë£¨] ë‹¨ê³„ë³„ë¡œ ì •ë°€ ë¶„ì„í•˜ì„¸ìš”.
2. ë¶€ìƒ ìœ„í—˜(ì†ëª©, ì–´ê¹¨, ë¬´ë¦)ì„ ì²´í¬í•˜ì„¸ìš”.
3. êµì •í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì—°ìŠµë²•(Drill)ì„ 1~2ê°œ ì¶”ì²œí•˜ì„¸ìš”.
4. ë§íˆ¬ëŠ” ê²©ë ¤í•˜ë©´ì„œë„ ì „ë¬¸ì ì¸ ì½”ì¹˜ì²˜ëŸ¼ í•˜ì„¸ìš”.
"""

def process_video(uploaded_file):
    """ë™ì˜ìƒì„ ì„ì‹œ ì €ì¥í•˜ê³  AIì—ê²Œ ì—…ë¡œë“œí•˜ëŠ” í•¨ìˆ˜"""
    # 1. ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
    with open("temp_video.mp4", "wb") as f:
        f.write(uploaded_file.read())
    
    # 2. Google AI ì„œë²„ë¡œ ì—…ë¡œë“œ
    video_file = genai.upload_file(path="temp_video.mp4")
    
    # 3. ì²˜ë¦¬ ì™„ë£Œ ëŒ€ê¸° (ë™ì˜ìƒì€ ì²˜ë¦¬ì— ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦¼)
    while video_file.state.name == "PROCESSING":
        time.sleep(2)
        video_file = genai.get_file(video_file.name)
        
    return video_file

def generate_response(prompt, content=None, is_video=False):
    full_prompt = [grand_slam_prompt, prompt]
    
    with st.spinner("ì½”ì¹˜ê°€ ì˜ìƒì„ í”„ë ˆì„ ë‹¨ìœ„ë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (10~20ì´ˆ ì†Œìš”) ğŸ¾"):
        try:
            if content:
                # ë™ì˜ìƒì´ë‚˜ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ì™€ í•¨ê»˜ ì „ë‹¬
                response = model.generate_content(full_prompt + [content])
            else:
                response = model.generate_content(full_prompt)
            return response.text
        except Exception as e:
            return f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"

# --- ë©”ì¸ íƒ­ ---
tab1, tab2, tab3 = st.tabs(["ğŸ¥ ìŠ¤ìœ™ ì˜ìƒ ë¶„ì„", "ğŸ“¸ ì‚¬ì§„ ë¶„ì„", "ğŸ§  ì „ëµ & ë©˜íƒˆ"])

with tab1:
    st.header("ë¹„ë””ì˜¤ ì½”ì¹­ (Beta)")
    st.info("ğŸ’¡ íŒ: 10ì´ˆ ì´ë‚´ì˜ ì§§ì€ ìŠ¤ìœ™ ì˜ìƒ(ì„œë¸Œ, í¬í•¸ë“œ ë“±)ì„ ì˜¬ë¦¬ë©´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.")
    
    video_upload = st.file_uploader("ë™ì˜ìƒ ì—…ë¡œë“œ (mp4, mov ë“±)", type=['mp4', 'mov', 'avi'])
    
    if video_upload:
        st.video(video_upload) # ì—…ë¡œë“œí•œ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°
        
        if st.button("ì˜ìƒ ì •ë°€ ë¶„ì„ ì‹œì‘ ğŸš€"):
            # ë¹„ë””ì˜¤ ì²˜ë¦¬
            processed_video = process_video(video_upload)
            # AI ë¶„ì„ ìš”ì²­
            result = generate_response("ì´ í…Œë‹ˆìŠ¤ ìŠ¤ìœ™ ì˜ìƒì„ ë¶„ì„í•˜ê³  ê°œì„ ì ì„ ì•Œë ¤ì¤˜.", processed_video, is_video=True)
            st.markdown("---")
            st.markdown(result)
            
            # (ì„ íƒ) ì„ì‹œ íŒŒì¼ ì‚­ì œ
            if os.path.exists("temp_video.mp4"):
                os.remove("temp_video.mp4")

with tab2:
    st.header("ìì„¸ ì‚¬ì§„ ë¶„ì„")
    img_upload = st.file_uploader("ì‚¬ì§„ ì—…ë¡œë“œ", type=["jpg", "png", "jpeg"])
    if img_upload:
        image = Image.open(img_upload)
        st.image(image, use_column_width=True)
        if st.button("ì‚¬ì§„ ë¶„ì„ ì‹œì‘"):
            result = generate_response("ì´ ìì„¸ë¥¼ ë¶„ì„í•´ì¤˜.", image)
            st.markdown(result)

with tab3:
    st.header("ë©˜íƒˆ & ì „ëµ")
    query = st.text_input("ì§ˆë¬¸ (ì˜ˆ: ë¸Œë ˆì´í¬ í¬ì¸íŠ¸ ë•Œ ë„ˆë¬´ ë–¨ë ¤)")
    if st.button("ì¡°ì–¸ êµ¬í•˜ê¸°"):
        st.markdown(generate_response(query))
